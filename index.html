<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Crossroads</title>
<link rel="stylesheet" href="index.css">
</head>
<body>
<div id="game">
  <h1 id="title">Loading…</h1>
  <p id="text"></p>
  <div class="choices" id="choices"></div>
  <div class="meta">
    <span id="inv" class="badge">Inventory: —</span>
    <button id="restart" aria-label="Restart story">Restart</button>
    <button id="softreset" aria-label="Go to start (keep items)">Back to Start</button>
  </div>
</div>

<script>
const stateKey = "cyoa_state";
const nodeKey  = "cyoa_node";
let state = JSON.parse(localStorage.getItem(stateKey) || "{}");

function saveState() { localStorage.setItem(stateKey, JSON.stringify(state)); }
function clearState() { state = {}; saveState(); }
function setState(patch) { state = { ...state, ...patch }; saveState(); }

const story = {
  start: {
    title: "At the Forest Edge",
    text: "You stand where old oaks meet the moor, night just beginning to thicken. Beyond the pines lies Brindle, the moonlit town, and farther still the ruined keep of Eldergate.\n\nEveryone knows the old story: Eldergate once guarded the crossroads of the world, until its key was shattered into three fragments. The gate has slept ever since. Tonight, you’ve decided to see if the stories are true.",
    choices: [
      { label: "Enter the Whispering Forest", goto: "forest" },
      { label: "Head to Brindle (town)", goto: "town" },
      { label: "Follow the gorge road toward the caves", goto: "road" }
    ]
  },

  /* FOREST */
  forest: {
    title: "Whispering Forest",
    text: "Leaves murmur like distant voices. Mist curls around roots. A faint glow flickers between trunks; a fox watches with curious, moon-bright eyes.\n\nSomewhere in this forest, they say, the first fragment of Eldergate’s key took root.",
    choices: [
      { label: "Follow the glow", goto: "glow" },
      { label: "Approach the fox", goto: "fox" },
      { label: "Leave the path and follow the whispers deeper", goto: "end_forestLost" },
      { label: "Return to the edge", goto: "start" }
    ]
  },

  glow: {
    title: "Moss-Lit Hollow",
    text: "A lantern hangs from a low branch, its river-green light caught in glass. The warm green flame illuminates a strance crecent shaped piece of wood in the base.",
    choices: [
      { label: "Take the lantern (and its strange shard)", goto: "forest", set: { hasLantern: true, forestFragment: true } },
      { label: "Leave it be", goto: "forest" }
    ]
  },

  fox: {
    title: "Red Messenger",
    text: "A voice speaks inside your head: “Light for dark. Offering for key. A fair trade, little wanderer.” The fox growls quietly as you approach.",
    choices: [
      { label: "Offer a gentle pat", goto: "blessing", set: { foxBlessing: true, forestFragment: true } },
      { label: "Back away slowly", goto: "forest" }
    ]
  },

  blessing: {
    title: "Forest's Favor",
    text: "Warmth pools in your palms, shaped like a tiny crescent of bark.",
    choices: [
      { label: "Return to the path", goto: "forest" }
    ]
  },

  end_forestLost: {
    title: "Game Over: Swallowed by Green",
    text: "You leave the path, chasing whispers that sound like your name. The trees fold in behind you. Days later, travelers speak of strange lantern glows deeper in the wood—but never of you.",
    choices: [
      { label: "Try again from the forest edge", goto: "start", set: { _reset: true } }
    ]
  },

  /* TOWN */
  town: {
    title: "Brindle by Moonlight",
    text: "Lanterns sway along cobbled lanes. A tavern buzzes with song. A small shrine watches the square, silver coins and river stones in its bowl.\n\nThe second fragment of the key is rumored to have fallen somewhere inside the town’s walls.",
    choices: [
      { label: "Enter the tavern", goto: "tavern" },
      { label: "Visit the shrine", goto: "shrine" },
      { label: "Ask the gatewarden about Eldergate", goto: "gatewarden" },
      { label: "Head back", goto: "start" }
    ]
  },

  tavern: {
    title: "The Silver Kettle",
    text: "Spiced stew steams by the hearth. A bard sings of dragons that sleep under bridges and a keep whose door only opens to moonlight.",
    choices: [
      { label: "Listen to the bard (learn a rumor)", goto: "rumor", set: { knowsBridge: true } },
      { label: "Buy provisions (rations)", goto: "town", set: { hasRations: true } },
      { label: "Join a drinking contest with the locals", goto: "end_townCursed" },
      { label: "Return to the square", goto: "town" }
    ]
  },

  rumor: {
    title: "Song of the Bridge",
    text: "The bard sings of a troll who takes kindness as toll, and of a gate that demands a moon-shaped key forged from scattered shards.",
    choices: [
      { label: "Head back into town", goto: "town" }
    ]
  },

  shrine: {
    title: "Shrine of the Moon",
    text: "Candles circle around a smooth stone statue. A bowl of river stones and coins invites an offering.",
    choices: [
      { label: "Make an offering", goto: "town", set: { moonToken: true, townFragment: true } },
      { label: "Whisper a prayer for safe paths", goto: "town", set: { prayed: true } },
      { label: "Pocket the offerings instead", goto: "end_townCursed" },
      { label: "Return to the square", goto: "town" }
    ]
  },

  gatewarden: {
    title: "Gatewarden Hobb",
    text: "“Eldergate’s cursed,” says Hobb, moustache bristling. “If you must go, take light and mind the bridge troll if you cross the north span. They say the gate won’t open without a key the moon itself.”",
    choices: [
      { label: "Thank him and head out", goto: "start" },
      { label: "Ask about the troll", goto: "trollTip", if: s => !!s.knowsBridge }
    ]
  },

  trollTip: {
    title: "Old Stories",
    text: "“Toll’s not coin,” Hobb says. “It’s kindness. Share food or a tale and you’ll pass unbitten.”",
    choices: [
      { label: "Got it", goto: "town" }
    ]
  },

  end_townCursed: {
    title: "Game Over: Ill-Favored by Moonlight",
    text: "Whether you drink yourself under the table or steal from the shrine, the Moon turns its face from you. Your journey ends in Brindle, with a bad hangover and worse luck.",
    choices: [
      { label: "Start over at the forest edge", goto: "start", set: { _reset: true } }
    ]
  },

  /* CAVE  */
  road: {
    title: "Old King’s Road",
    text: "Stones cracked by roots lead toward a misting gorge. To the north, a bridge arcs over a dark chasm. To the south, a cave yawns in the cliff.\n\nMiners once swore they saw the third fragment of the moon-key carved into the rock somewhere beneath these hills.",
    choices: [
      { label: "Cross the north bridge", goto: "bridge" },
      { label: "Explore the cave", goto: "cave" },
      { label: "Return to the forest edge", goto: "start" }
    ]
  },

  bridge: {
    title: "Bridge of Sighs",
    text: "A shape hunched beneath the arch sniffs the night air.",
    choices: [
      { label: "Call out kindly", goto: "trollHello" },
      { label: "Offer rations", goto: "trollTrade", if: s => !!s.hasRations },
      { label: "Try to sneak past", goto: "trollSneak" }
    ]
  },

  trollHello: {
    title: "Bridge-Troll Brum",
    text: "“Hungry,” rumbles the voice. “Got story? Got snack?”",
    choices: [
      { label: "Tell a story", goto: "trollPass",
        if: s => s.foxBlessing || s.knowsBridge },
      { label: "I have a snack", goto: "trollTrade", if: s => !!s.hasRations },
      { label: "No, sorry…", goto: "trollSneak" }
    ]
  },

  trollTrade: {
    title: "A Fair Toll",
    text: "You share food. The troll’s eyes soften. “Pass, friend.”",
    choices: [
      { label: "Cross the bridge", goto: "beyondBridge", set: { crossedBridge: true } }
    ]
  },

  trollSneak: {
    title: "Cracked Plank",
    text: "The plank snaps; you tumble—dangling. A huge hand hauls you up with a sigh.",
    choices: [
      { label: "Accept help, promise kindness next time", goto: "trollPass", set: { owesKindness: true } }
    ]
  },

  trollPass: {
    title: "Words as Bridge",
    text: "Your tale drifts over water. Brum smiles, tusks gleaming. “Go on, traveler.”",
    choices: [
      { label: "Cross the bridge", goto: "beyondBridge", set: { crossedBridge: true } }
    ]
  },

  cave: {
    title: "Murk-Grot",
    text: "Cold breath of stone washes over you. Without light, the dark feels thick enough to chew.",
    choices: [
      { label: "Use your lantern", goto: "caveLit", if: s => !!s.hasLantern },
      { label: "Feel along the wall (risky)", goto: "caveRisk" },
      { label: "Back to the road", goto: "road" }
    ]
  },

  caveRisk: {
    title: "Blind Step",
    text: "Your foot slides—then steadies on a flat stone. Something smooth rests nearby, just out of sight.",
    choices: [
      { label: "Grab it and leave (maybe it’s useful)", goto: "road", set: { moonToken: true } },
      { label: "Keep feeling your way deeper into the dark", goto: "end_caveFall" },
      { label: "Retreat carefully", goto: "road" }
    ]
  },

  caveLit: {
    title: "Lantern Glow",
    text: "Runes glitter on the walls. A small chest sits in a niche, secured by a crescent-shaped lock that almost matches the stories of the moon-key.",
    choices: [
      { label: "Use Moon Token to open", goto: "chest", if: s => !!s.moonToken },
      { label: "Examine runes", goto: "runes" },
      { label: "Leave the cave", goto: "road" }
    ]
  },

  runes: {
    title: "Stone Whispers",
    text: "“To open, bring moon to stone,” the runes suggest. It seems the lock wants a crescent-shaped token.",
    choices: [
      { label: "Back", goto: "caveLit" }
    ]
  },

  chest: {
    title: "Gift of Stone",
    text: "Inside the chest lies a heavy shard of silvered rock, cut into a curve that clearly fits with others. The third fragment of the key.",
    choices: [
      { label: "Take the Cave Shard", goto: "road", set: { caveFragment: true } }
    ]
  },

  end_caveFall: {
    title: "Game Over: The Long Drop",
    text: "Your searching hand finds only empty air. The cave floor vanishes, and the darkness rushes up to meet you. Somewhere far above, your lanternless adventure ends.",
    choices: [
      { label: "Start again at the forest edge", goto: "start", set: { _reset: true } }
    ]
  },

  /* APPROACH */
  beyondBridge: {
    title: "Eldergate Approach",
    text: "Ruined towers encircle a black gate laced with living vines. As you draw closer, any key fragments you carry seem to hum and tug toward one another.",
    choices: [
      { label: "Assemble the Key from your three shards", 
        goto: "gateOpen",
        if: s => s.forestFragment && s.townFragment && s.caveFragment,
        set: { hasSigil: true } 
      },
      { label: "Knock (politely)", goto: "gateKnock" },
      { label: "Circle the walls", goto: "walls" }
    ]
  },

  walls: {
    title: "Cracked Parapet",
    text: "You find a toppled section—too high to climb without help. You see a small burrow about the right size for a fox.",
    choices: [
      { label: "Call for the fox", goto: "foxAid", if: s => !!s.foxBlessing },
      { label: "Return to the gate", goto: "beyondBridge" }
    ]
  },

  foxAid: {
    title: "A Friend Returns",
    text: "The red fox appears, tail puffed like a banner. Illusory steps bloom in the air, leading up and over the broken wall.",
    choices: [
      { label: "Ascend the steps", goto: "innerKeep", set: { enteredEldergate: true } }
    ]
  },

  gateKnock: {
    title: "The Silent Gate",
    text: "Your knock echoes. The vines draw tighter, as if listening.",
    choices: [
      { label: "Wait…", goto: "gateWait" },
      { label: "Step back to consider options", goto: "beyondBridge" }
    ]
  },

  gateWait: {
    title: "Answer in Vines",
    text: "The vines relax a little—as if expecting a sign.",
    choices: [
      { label: "Hold up the lantern", goto: "gateGlow", if: s => !!s.hasLantern },
      { label: "Whisper a prayer", goto: "gatePrayer", if: s => !!s.prayed },
      { label: "Return", goto: "beyondBridge" }
    ]
  },

  gateGlow: {
    title: "Light Recognizes Light",
    text: "The lantern’s river-green glow matches the vines’ pulse. They unweave, revealing a path inside.",
    choices: [
      { label: "Enter Eldergate", goto: "innerKeep", set: { enteredEldergate: true } }
    ]
  },

  gatePrayer: {
    title: "Moon Call",
    text: "A cool breeze sweeps through. The vines slump, soothed, and part just enough to slip through.",
    choices: [
      { label: "Slip inside", goto: "innerKeep", set: { enteredEldergate: true } }
    ]
  },

  gateOpen: {
    title: "Key of the Broken Moon",
    text: "Your forest, town, and cave shards snap together with a soft chime, forming a crescent Moon-Key. The gate unfurls like a sighing book, pages of stone turning inward.",
    choices: [
      { label: "Walk into Eldergate", goto: "innerKeep", set: { enteredEldergate: true } }
    ]
  },

  /*  KEEP  */
  innerKeep: {
    title: "Heart of Eldergate",
    text: "An empty throne, a sleeping power. Your Moon-Key (and the fox’s lingering blessing, if you carry it) hums in your hand. The keep seems to lean toward your next words.",
    choices: [
      { label: "Swear to guard this place", goto: "end_guardian" },
      { label: "Wake the old magic for yourself", goto: "end_awakener", if: s => s.hasSigil || s.foxBlessing },
      { label: "Leave it sleeping and go home", goto: "end_pilgrim" },
      {
        label: "Stand between sleeping and waking (Threshold Ending)",
        goto: "end_threshold",
        if: s => !(s.forestFragment && s.townFragment && s.caveFragment) && !s.hasSigil
      }
    ]
  },

  end_guardian: {
    title: "Ending: Warden of the Crossroads",
    text: "You choose the simplest vow and the hardest life: to stay.\n\nUnder your watch, Eldergate stops being a rumor and becomes a promise. Travelers who reach its gate find a listening ear and a safe fire if you deem them worthy. The Key hangs at your belt and the road slowly bends new paths toward the keep.\n\nYears from now, children in Brindle will point to the glimmer on the hill and say, “That’s where the Warden lives.”",
    choices: [
      { label: "Play again (clear progress)", goto: "start", set: { _reset: true } }
    ]
  },

  end_awakener: {
    title: "Ending: The Moon Stirs",
    text: "You do not sit the throne; you wake it.\n\nYour words spill into Eldergate like light into a dry well. Magic that slept for centuries stretches, yawns, and spills outward in quiet waves. In the forest, strange leaves fall in crescent shapes. In Brindle, people dream of silver gates and wake to an uneasy feeling. Deep below the hills, tunnels straighten just enough to find every corner of the world.",
    choices: [
      { label: "Play again (clear progress)", goto: "start", set: { _reset: true } }
    ]
  },

  end_pilgrim: {
    title: "Ending: The One Who Walked Away",
    text: "You turn away before Eldergate can decide what to make of you.\n\nThe gate shrinks behind you with every step, until it’s just another shape in the hills. The world ahead is wide and ordinary, but every crossroad feels a little sharper now. You carry what you learned here like a quiet stone in your pocket.\n\nIn inns and field-camps, you tell a story about a ruined keep and a key made from broken moonlight. You never finish the tale quite the same way twice.",
    choices: [
      { label: "Play again (clear progress)", goto: "start", set: { _reset: true } }
    ]
  },

  end_threshold: {
    title: "Ending: The Threshold Walker",
    text: "You reached the heart of Eldergate without a perfect key, without every shard in its proper place.\n\nInstead of the throne, you choose the bottom step. From there, you can see both the gate and the hall behind you. You learn the keep’s creaks and silences, the way the air tightens when storms roll over the hills.\n\nYou do not fully wake Eldergate, and you do not let it sleep. When travelers arrive at uncertain moments, they find you sitting on the step, deciding whether to send them away or invite them deeper. Years from now, people will argue about whether the keep ever truly returned. You will shrug, still sitting where you belong: right on the threshold.",
    choices: [
      { label: "Play again (clear progress)", goto: "start", set: { _reset: true } }
    ]
  }
};

/*  ENGINE  */
const $title   = document.getElementById("title");
const $text    = document.getElementById("text");
const $choices = document.getElementById("choices");
const $inv     = document.getElementById("inv");
const $restart = document.getElementById("restart");
const $soft    = document.getElementById("softreset");

function inventoryLabel(s) {
  const items = [];
  if (s.hasLantern) items.push("Lantern");
  if (s.hasRations) items.push("Rations");
  if (s.moonToken) items.push("Moon Token");
  if (s.forestFragment) items.push("Forest Shard");
  if (s.townFragment) items.push("Town Shard");
  if (s.caveFragment) items.push("Cave Shard");
  if (s.hasSigil) items.push("Moon-Key");
  if (s.foxBlessing) items.push("Fox’s Favor");
  return "Inventory: " + (items.length ? items.join(", ") : "—");
}

function go(id) {
  if (!story[id]) return;
  location.hash = id;
  localStorage.setItem(nodeKey, id);
  render(id);
}

function render(id) {
  const node = story[id];

  
  $title.textContent = node.title;
  $text.textContent  = node.text;
  $choices.innerHTML = "";

  
  $inv.textContent = inventoryLabel(state);

  node.choices.forEach(choice => {
    if (choice.if && !choice.if(state)) return; 
    const btn = document.createElement("button");
    btn.textContent = choice.label;
    btn.addEventListener("click", () => {
      if (choice.set) {
        if (choice.set._reset) {
          clearState();
        } else {
          setState(choice.set);
        }
      }
      go(choice.goto);
    });
    $choices.appendChild(btn);
  });
}

window.addEventListener("hashchange", () => {
  const id = location.hash.slice(1);
  if (story[id]) render(id);
});

$restart.addEventListener("click", () => {
  clearState();
  go("start");
});

$soft.addEventListener("click", () => go("start"));

const initial = location.hash.slice(1) || localStorage.getItem(nodeKey) || "start";
go(initial);
</script>
</body>
</html>
